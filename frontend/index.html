<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PPE Detection Web App</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }
    h1 {
      margin-bottom: 8px;
    }
    .upload-box {
      border: 2px dashed #aaa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 16px;
    }
    #preview {
      max-width: 100%;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    #result-image {
      max-width: 100%;
      margin-top: 16px;
      border-radius: 8px;
      border: 2px solid #444;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 14px;
      text-align: center;
    }
    th {
      background: #f5f5f5;
    }
    .warning {
      background-color: #ffe6e6;
      color: #c00;
      font-weight: bold;
    }

    /* ğŸ”¥ A-1 ê²½ê³  ë°°ë„ˆ */
    #alert-box {
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      margin-top: 16px;
      background-color: #ffe6e6;
      color: #c00;
      border: 2px solid #c00;
      display: none;
    }

    /* ğŸ”¥ A-4 ìš”ì•½ ë°•ìŠ¤ */
    #summary-box {
      background: #f7f7f7;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>PPE Detection Web App</h1>
  <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ YOLO ëª¨ë¸ì´ PPE ì°©ìš© ì—¬ë¶€ë¥¼ ë¶„ì„í•´ì¤ë‹ˆë‹¤.</p>

  <div class="upload-box">
    <input type="file" id="file-input" accept="image/*" />
    <p>ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ í›„ ìë™ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡ë©ë‹ˆë‹¤.</p>
    <img id="preview" src="" alt="" style="display:none;" />
  </div>

  <div id="status"></div>

  <!-- ğŸ”¥ ê²½ê³  ë°•ìŠ¤ -->
  <div id="alert-box"></div>

  <!-- ğŸ”¥ ìš”ì•½ ë°•ìŠ¤ -->
  <div id="summary-box"></div>

  <h2>Detection Result</h2>
  <img id="result-image" src="" alt="ê°ì§€ ê²°ê³¼ ì´ë¯¸ì§€" style="display:none;" />

  <table id="result-table" style="display:none;">
    <thead>
      <tr>
        <th>#</th>
        <th>Class</th>
        <th>Confidence</th>
        <th>ê²½ê³  ì—¬ë¶€</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const fileInput = document.getElementById('file-input');
    const previewImg = document.getElementById('preview');
    const resultImg = document.getElementById('result-image');
    const resultTable = document.getElementById('result-table');
    const resultTbody = resultTable.querySelector('tbody');
    const statusDiv = document.getElementById('status');
    const alertBox = document.getElementById('alert-box');
    const summaryBox = document.getElementById('summary-box');

    const warningClasses = ["NO-Mask", "NO-Hardhat", "NO-Safety Vest"];

    function isWarningClass(className) {
      return warningClasses.includes(className);
    }

    fileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      // ë¯¸ë¦¬ë³´ê¸°
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.style.display = 'block';
      };
      reader.readAsDataURL(file);

      resultImg.style.display = 'none';
      resultTable.style.display = 'none';
      alertBox.style.display = 'none';
      summaryBox.style.display = 'none';

      statusDiv.textContent = "ì„œë²„ì— ì´ë¯¸ì§€ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('http://127.0.0.1:8000/predict', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        statusDiv.textContent = `ì´ ${data.num_detections}ê°œì˜ ê°ì²´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`;

        // ê²°ê³¼ ì´ë¯¸ì§€
        if (data.image_base64) {
          resultImg.src = 'data:image/jpeg;base64,' + data.image_base64;
          resultImg.style.display = 'block';
        }

        // í…Œì´ë¸”
        resultTbody.innerHTML = '';

        let warningCount = 0;
        let warningList = [];

        // í´ë˜ìŠ¤ ìš”ì•½
        const classSummary = {};

        data.detections.forEach((det, idx) => {
          const tr = document.createElement('tr');
          const tdIdx = document.createElement('td');
          const tdClass = document.createElement('td');
          const tdConf = document.createElement('td');
          const tdWarn = document.createElement('td');

          tdIdx.textContent = idx + 1;
          tdClass.textContent = det.class_name;
          tdConf.textContent = det.confidence.toFixed(3);

          // ê²½ê³  ì—¬ë¶€
          if (isWarningClass(det.class_name)) {
            tr.classList.add('warning');
            tdWarn.textContent = "âš  ê²½ê³ ";
            warningCount++;
            warningList.push(det.class_name);
          } else {
            tdWarn.textContent = "-";
          }

          // ìš”ì•½
          classSummary[det.class_name] =
            (classSummary[det.class_name] || 0) + 1;

          tr.appendChild(tdIdx);
          tr.appendChild(tdClass);
          tr.appendChild(tdConf);
          tr.appendChild(tdWarn);

          resultTbody.appendChild(tr);
        });

        resultTable.style.display = 'table';

        // ğŸ”¥ ê²½ê³  ë°°ë„ˆ
        if (warningCount > 0) {
          alertBox.style.display = 'block';
          const summary = warningList
            .reduce((acc, cls) => {
              acc[cls] = (acc[cls] || 0) + 1;
              return acc;
            }, {});
          const text = Object.entries(summary)
            .map(([cls, cnt]) => `${cls} ${cnt}ê±´`)
            .join(", ");
          alertBox.textContent = `âš  PPE ìœ„ë°˜ ê°ì§€: ${text}`;
        }

        // ğŸ”¥ ìš”ì•½ ë°•ìŠ¤
        summaryBox.style.display = 'block';
        summaryBox.innerHTML =
          "<b>í´ë˜ìŠ¤ ìš”ì•½:</b><br>" +
          Object.entries(classSummary)
            .map(([cls, cnt]) => `${cls}: ${cnt}`)
            .join("<br>");

      } catch (err) {
        console.error(err);
        statusDiv.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    });
  </script>
</body>
</html>
